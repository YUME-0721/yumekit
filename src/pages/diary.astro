---
import { siteConfig } from "../config";
import { getDiaryList, getDiaryStats } from "../data/diary";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// æ£€æŸ¥æ—¥è®°é¡µé¢æ˜¯å¦å¯ç”¨
if (siteConfig.featurePages?.diary === false) {
	return Astro.redirect("/404/");
}

// è·å–æ—¥è®°æ•°æ®
const moments = getDiaryList();
const diaryStats = getDiaryStats();

// æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatTime(dateString: string): string {
	const now = new Date();
	const date = new Date(dateString);
	const diffInMinutes = Math.floor(
		(now.getTime() - date.getTime()) / (1000 * 60),
	);

	if (diffInMinutes < 60) {
		return `${diffInMinutes} åˆ†é’Ÿå‰`;
	}
	if (diffInMinutes < 1440) {
		const hours = Math.floor(diffInMinutes / 60);
		return `${hours} å°æ—¶å‰`;
	}
	const days = Math.floor(diffInMinutes / 1440);
	return `${days} å¤©å‰`;
}
---

<MainGridLayout title="æ—¥è®°" description="æˆ‘çš„æ—¥è®°">
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
      <div class="relative max-w-4xl w-full px-2 md:px-0">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="moments-header mb-6">
          <div class="header-content">
            <div class="header-info">
              <h1 class="moments-title text-xl md:text-2xl lg:text-3xl font-bold text-white mb-1">æ—¥è®°</h1>
              <p class="moments-subtitle text-sm md:text-base text-white/90">è®°å½•ç”Ÿæ´»çš„ç‚¹æ»´</p>
            </div>
            <div class="header-stats">
              <div class="stat-item text-center">
                <span class="stat-number text-lg md:text-xl lg:text-2xl font-bold text-white">{diaryStats.total}</span>
                <span class="stat-label text-xs md:text-sm text-white/80">æ¡æ—¥è®°</span>
              </div>
            </div>
          </div>
        </div>

        <!-- æ—¥è®°åˆ—è¡¨ -->
        <div class="moments-timeline">
          <div class="timeline-list space-y-4">
            {moments.map(moment => (
              <div class="moment-item card-base p-4 md:p-6 hover:shadow-lg transition-all">
                <div class="moment-content">
                  <p class="moment-text text-sm md:text-base text-black/90 dark:text-white/90 leading-relaxed mb-3">{moment.content}</p>
                  
                  {moment.images && moment.images.length > 0 && (
                    <div class="moment-images grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                      {moment.images.map((image) => (
                        <div class="image-item relative rounded-md overflow-hidden aspect-square cursor-pointer hover:scale-105 transition-transform">
                          <img 
                            src={image} 
                            alt="diary moment image"
                            class="w-full h-full object-cover"
                            loading="lazy"
                          />
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                <hr class="moment-divider border-t border-[var(--line-divider)] my-3" />
                
                <div class="moment-footer flex justify-between items-center">
                  <div class="moment-time flex items-center gap-1.5 text-black/50 dark:text-white/50 text-xs md:text-sm">
                    <span>ğŸ•</span>
                    <time datetime={moment.date}>
                      {formatTime(moment.date)}
                    </time>
                  </div>
                  {moment.mood && (
                    <span class="text-xl">{moment.mood}</span>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- åº•éƒ¨æç¤º -->
        <div class="moments-tips text-center mt-6 text-black/50 dark:text-white/50 text-xs italic">
          åªå±•ç¤ºæœ€è¿‘ 30 æ¡æ—¥è®°
        </div>
      </div>
    </div>
  </div>
</MainGridLayout>

<style>
  .card-base {
    background: var(--card-bg);
    border: 1px solid var(--line-divider);
    transition: all 0.3s ease;
  }
  
  .moments-header {
    padding: 1rem;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--primary) 0%, oklch(0.55 0.14 var(--hue)) 100%);
    color: white;
  }
  
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  @media (max-width: 640px) {
    .header-content {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
    }
  }
</style>
